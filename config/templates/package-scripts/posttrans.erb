#!/bin/sh
# GitLab post-transition script
# RPM only
DEST_DIR=<%= install_dir %>


# TODO : Check if posttrans script is actually needed, as this is duplication
# of postinst script
if [ -e /etc/gitlab/gitlab.rb ] ; then
  EXTERNAL_URL=$(awk '/^external_url/ { print $2 }' /etc/gitlab/gitlab.rb | tr -d "'\"")
fi

check_if_ec2()
{
  if [ -f /sys/hypervisor/uuid ] && [ `head -c 3 /sys/hypervisor/uuid` = 'ec2' ]; then
    return 0
  else
    return 1
  fi
}

get_ec2_hostname()
{
  # Try collecting fqdn if it is set correctly
  fqdn=$(/opt/gitlab/embedded/bin/curl -s http://169.254.169.254/latest/meta-data/public-hostname)
  if [ -n "${fqdn}" ]; then
    EXTERNAL_URL="http://${fqdn}"
  fi
}

if [ -z "${EXTERNAL_URL}" ]; then
  check_if_ec2
  if [ $? -eq 0 ]  ; then
    get_ec2_hostname
  else
    EXTERNAL_URL="http://gitlab.example.com"
  fi
fi

case "$1" in
  0)
    # RPM install/upgrade
    ${DEST_DIR}/embedded/bin/symlink_ctl_cmds ${DEST_DIR}
    EXTERNAL_URL=${EXTERNAL_URL} ${DEST_DIR}/bin/gitlab-ctl upgrade
    ;;
  *)
    # Noop.
    ;;
esac
